#include <iostream>
#include <fstream>
#include <cmath>
#include <string>
using namespace std;
const float pi = 3.141592;
int* SampleRate;
int n,k=0;

int getLength(int* h) {
    return (4 * 1 / *h);
}
float getfrequency(char* f) {
    if (*f == 'C')  return 130.81;
    else if (*f == 'D')  return 146.83;
    else if (*f == 'E')  return 164.81;
    else if (*f == 'F')  return 174.61;
    else if (*f == 'G')  return 196.00;
    else if (*f == 'A')  return 220.00;
    else if (*f == 'B')  return 246.94;
}
int getAmplitude(int* e) {
    return *e * 1000;
}
void makedata(int* T, int* a, float* f, short* data, int n, int* SR) {
    const float pi = 3.141592;
    float dt = 1. / *SR;
    for (int i = 0; i < n; i++) {
        for (int j = 0; j < T[i] * (*SR); j++) { data[j] = (*a) * sin(2.0 * pi * f[i] * j * dt); }
        }
}

int main() {
    char header[44];
    ifstream xx("Beatles.wav", ios::binary | ios::in);
    if (!xx) return 666;  // 만일 파일이 열리지 않으면 끝낸다. 
    xx.read(header, 44 * sizeof(char));
    short* NumChannels;
    NumChannels = (short*)(header + 22);
    int* SampleRate;
    SampleRate = (int*)(header + 24);
    short* BitsPerSample;
    BitsPerSample = (short*)(header + 34);
    xx.close();

    int* eu, *ss, *T, *a;
    float* f;
    char* hh;
    string text;

    ifstream zz("piece.txt");

    zz >> n; // 음표가 몇 개인지 읽기
    eu = new int[n];
    ss = new int[n];
    T = new int[n];
    a = new int[n];
    f = new float[n];
    hh = new char[n];

    for (int i = 0; i < n; i++) { 
        zz>> eu[i] >> hh[i] >> ss[i];  // eu ss는 int이고, hh는 char
        T[i] = getLength(eu);       // 시간이 return되는 함수
        f[i] = getfrequency(hh);    // 주파수가 return 되는 함수
        a[i] = getAmplitude(ss);    // 진폭이 return되는 함수
        k += T[i];
    }

    short* data; data = new short[k * (*SampleRate)];
    makedata(T, a, f, data, n, SampleRate);
    ofstream x1("my2.wav", ios::binary | ios::out);  // 나의 wave file에 만들어진 sample 개수만큼 write한다.
    if (!x1)return 666;
    *NumChannels = 1;
    *SampleRate = 44100;
    *BitsPerSample = 16;
    x1.write(header, sizeof(header));
    x1.write((char*)data, (*SampleRate*k) * sizeof(short));

}
